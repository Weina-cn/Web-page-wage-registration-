<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>å·¥èµ„ç™»è®°ç³»ç»Ÿ</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            min-height: 100vh;
            padding: 15px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .hidden {
            display: none !important;
        }
        
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .max-w-md {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .btn-main {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            transition: all 0.2s;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .btn-main::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .btn-main:active::after {
            width: 200px;
            height: 200px;
            opacity: 0;
        }
        
        .btn-small {
            padding: 12px 16px;
            font-size: 16px;
            font-weight: medium;
            border-radius: 8px;
            border: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-big {
            font-size: 22px;
            font-weight: bold;
        }
        
        .text-huge {
            font-size: 32px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        
        .text-gray-500 {
            color: #757575;
        }
        
        .text-gray-600 {
            color: #616161;
        }
        
        .text-gray-700 {
            color: #424242;
        }
        
        .text-gray-800 {
            color: #212121;
        }
        
        .text-primary {
            color: #2E7D32;
        }
        
        .text-white {
            color: white;
        }
        
        .input-field {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background-color: #fff;
        }
        
        .input-field:focus {
            border-color: #2E7D32;
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }
        
        .input-field::placeholder {
            color: #bdbdbd;
            transition: color 0.3s ease;
        }
        
        .input-field:focus::placeholder {
            color: #e0e0e0;
        }
        
        .bg-primary {
            background-color: #2E7D32;
            background-image: linear-gradient(135deg, #2E7D32 0%, #388E3C 100%);
        }
        
        .bg-accent {
            background-color: #FF9800;
            background-image: linear-gradient(135deg, #FF9800 0%, #FB8C00 100%);
        }
        
        .bg-success {
            background-color: #4CAF50;
            background-image: linear-gradient(135deg, #4CAF50 0%, #43A047 100%);
        }
        
        .bg-warning {
            background-color: #FFC107;
            background-image: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
        }
        
        .bg-neutral {
            background-color: #757575;
            background-image: linear-gradient(135deg, #757575 0%, #616161 100%);
        }
        
        .bg-gray-50 {
            background-color: #fafafa;
        }
        
        .mb-3 {
            margin-bottom: 10px;
        }
        
        .mb-4 {
            margin-bottom: 15px;
        }
        
        .mb-5 {
            margin-bottom: 20px;
        }
        
        .mt-2 {
            margin-top: 5px;
        }
        
        .mt-3 {
            margin-top: 10px;
        }
        
        .mt-4 {
            margin-top: 15px;
        }
        
        .mt-5 {
            margin-top: 20px;
        }
        
        .p-3 {
            padding: 10px;
        }
        
        .p-4 {
            padding: 15px;
        }
        
        .mr-2 {
            margin-right: 8px;
        }
        
        .mr-3 {
            margin-right: 12px;
        }
        
        .flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .items-center {
            align-items: center;
        }
        
        .space-y-4 > * {
            margin-bottom: 15px;
        }
        
        .max-h-52 {
            max-height: 210px;
        }
        
        .max-h-64 {
            max-height: 260px;
        }
        
        .overflow-y-auto {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #bdbdbd #f5f5f5;
        }
        
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #bdbdbd;
            border-radius: 20px;
        }
        
        .employee-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }
        
        .back-button {
            position: absolute;
            top: 15px;
            left: 15px;
            color: #616161;
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .back-button:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        
        .back-button:active {
            transform: scale(0.95);
        }
        
        .toast-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .icon-text {
            display: inline-block;
            width: 24px;
        }
        
        .permission-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            color: white;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .permission-prompt.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .permission-prompt button {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 18px;
            background-color: #2E7D32;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #4CAF50;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .voice-indicator.active {
            opacity: 1;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        /* å‘˜å·¥çŠ¶æ€é¡¹æ ·å¼ä¼˜åŒ– */
        .status-item {
            padding: 12px 15px;
            border-radius: 8px;
            background-color: #f5f5f5;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-item:hover {
            background-color: #eeeeee;
            transform: translateX(3px);
        }
        
        .status-item.registered {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4CAF50;
        }

        /* å‘˜å·¥åˆ—è¡¨é¡¹æ ·å¼ä¼˜åŒ– */
        .employee-item {
            padding: 12px 15px;
            border-radius: 8px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .employee-item:hover {
            background-color: #eeeeee;
        }
        
        .employee-item .delete-btn {
            color: #f44336;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.7;
            transition: all 0.2s;
            padding: 4px;
        }
        
        .employee-item .delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* ç•Œé¢åˆ‡æ¢åŠ¨ç”» */
        .screen {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .screen.hidden {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <audio id="audio-player" preload="none" style="display: none;"></audio>
    
    <div id="voice-indicator" class="voice-indicator"></div>
    
    <!-- ä¸»ç•Œé¢æ·»åŠ screenç±»ç”¨äºåŠ¨ç”» -->
    <div id="main-screen" class="max-w-md screen">
        <div class="text-center mb-6 mt-3">
            <h1 class="text-big text-gray-800">å·¥èµ„ç™»è®°</h1>
            <p id="current-date" class="text-gray-600 mt-3">2024å¹´5æœˆ15æ—¥ æ˜ŸæœŸä¸‰</p>
            <div class="mt-4">
                <p id="employee-progress" class="text-gray-500">å‘˜å·¥ 1/3</p>
                <p id="current-employee-display" class="text-huge text-primary mt-2">å¼ ä¸‰</p>
            </div>
        </div>
        
        <div class="card fade-enter">
            <div class="mb-5">
                <label for="today-salary" class="block text-gray-700 mb-3">ä»Šæ—¥å·¥èµ„ï¼ˆå…ƒï¼‰</label>
                <input 
                    type="number" 
                    id="today-salary" 
                    class="input-field" 
                    placeholder="è¯·è¾“å…¥é‡‘é¢"
                    step="0.01"
                    min="0"
                    autocomplete="off"
                >
            </div>
            
            <button 
                id="record-button" 
                class="btn-main bg-accent text-white"
                disabled
            >
                <span class="icon-text">âœ“</span>ç™»è®°å·¥èµ„
            </button>
            
            <button 
                id="re-register-button" 
                class="btn-main bg-warning text-gray-800 hidden"
            >
                <span class="icon-text">â†º</span>é‡æ–°ç™»è®°
            </button>
            
            <button 
                id="settings-button" 
                class="btn-main bg-neutral text-white"
            >
                <span class="icon-text">âš™</span>ç³»ç»Ÿè®¾ç½®
            </button>
        </div>
        
        <div class="card fade-enter" style="transition-delay: 0.1s">
            <h2 class="text-big text-gray-800 mb-4 flex items-center">
                <span class="icon-text">ğŸ“‹</span>ä»Šæ—¥ç™»è®°çŠ¶æ€
            </h2>
            
            <div id="today-status-list" class="space-y-4 max-h-52 overflow-y-auto mb-5">
                <!-- åŠ¨æ€æ˜¾ç¤ºä»Šæ—¥ç™»è®°çŠ¶æ€ -->
            </div>
            
            <button 
                id="skip-button" 
                class="btn-small bg-neutral text-white w-full"
                disabled
            >
                <span class="icon-text">â†’</span>è·³è¿‡å½“å‰å‘˜å·¥
            </button>
        </div>
    </div>
    
    <div id="settings-screen" class="max-w-md screen hidden" style="position: relative; padding-bottom: 30px;">
        <div class="text-center mb-6 mt-5" style="padding-top: 20px;">
            <button id="back-button" class="back-button">â†</button>
            <h1 class="text-big text-gray-800">ç³»ç»Ÿè®¾ç½®</h1>
        </div>
        
        <div class="card fade-enter">
            <h2 class="text-big text-gray-800 mb-5 flex items-center">
                <span class="icon-text">ğŸ“…</span>æ—¥æœŸè®¾ç½®
            </h2>
            
            <div class="mb-5">
                <label for="setting-date" class="block text-gray-700 mb-3">å½“å‰ç™»è®°æ—¥æœŸ</label>
                <input 
                    type="date" 
                    id="setting-date" 
                    class="input-field"
                >
            </div>
            
            <button 
                id="save-date-button" 
                class="btn-main bg-primary text-white"
            >
                <span class="icon-text">ğŸ’¾</span>ä¿å­˜æ—¥æœŸè®¾ç½®
            </button>
        </div>
        
        <div class="card fade-enter" style="transition-delay: 0.1s">
            <h2 class="text-big text-gray-800 mb-5 flex items-center">
                <span class="icon-text">â•</span>æ·»åŠ å‘˜å·¥
            </h2>
            
            <div class="mb-5">
                <input 
                    type="text" 
                    id="new-employee-name" 
                    class="input-field" 
                    placeholder="è¯·è¾“å…¥å‘˜å·¥å§“å"
                    autocomplete="off"
                >
            </div>
            
            <button 
                id="add-employee-button" 
                class="btn-main bg-primary text-white"
            >
                <span class="icon-text">+</span>æ·»åŠ å‘˜å·¥
            </button>
        </div>
        
        <div class="card fade-enter" style="transition-delay: 0.2s">
            <h2 class="text-big text-gray-800 mb-5 flex items-center">
                <span class="icon-text">ğŸ‘¥</span>å‘˜å·¥åˆ—è¡¨
            </h2>
            
            <div id="employees-list" class="space-y-4 max-h-64 overflow-y-auto">
                <p class="text-gray-500 text-center p-3">æš‚æ— å‘˜å·¥</p>
            </div>
        </div>
        
        <div class="card fade-enter" style="transition-delay: 0.3s">
            <button 
                id="export-button" 
                class="btn-main bg-primary text-white"
            >
                <span class="icon-text">ğŸ“¤</span>å¯¼å‡ºExcelè¡¨æ ¼
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ä¿æŒä¸å˜
        let currentDate, todayStr, todayFullDate;
        let employees = [];
        let currentEmployeeIndex = 0;
        let salaryRecords = [];
        let isSpeaking = false;
        let audioSupported = false;
        let xlsxScriptLoaded = false;
        let voiceInited = false;
        let voiceQueue = []; 
        let isProcessingQueue = false;
        let audioPlayer;
        
        // åˆå§‹åŒ–å‡½æ•°
        document.addEventListener('DOMContentLoaded', function() {
            audioPlayer = document.getElementById('audio-player');
            
            audioPlayer.onended = function() {
                isSpeaking = false;
                document.getElementById('voice-indicator').classList.remove('active');
                setTimeout(processVoiceQueue, 200);
            };
            
            audioPlayer.onerror = function(error) {
                console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error);
                isSpeaking = false;
                document.getElementById('voice-indicator').classList.remove('active');
                setTimeout(processVoiceQueue, 500);
            };
            
            // æ˜¾ç¤ºå½“å‰æ—¥æœŸ
            const now = new Date();
            const options = { month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', options);
            
            // åˆå§‹åŒ–åŠ¨ç”»ç±»
            setTimeout(() => {
                document.querySelectorAll('.fade-enter').forEach(el => {
                    el.classList.add('fade-enter-active');
                });
            }, 100);
            
            initVoiceAndSystem();
        });
        
        // åˆå§‹åŒ–è¯­éŸ³å’Œç³»ç»Ÿ
        function initVoiceAndSystem() {
            checkAudioSupport();
            
            const permissionPrompt = document.getElementById('permission-prompt');
            if (permissionPrompt) permissionPrompt.classList.add('hidden');
            
            document.getElementById('main-screen').classList.remove('hidden');
            
            currentDate = new Date();
            updateDateInfo(currentDate);
            
            document.getElementById('setting-date').value = todayFullDate;
            
            loadData();
            
            setTimeout(() => {
                updateEmployeesList();
                setTimeout(() => {
                    updateTodayStatusList();
                    
                    if (employees.length > 0) {
                        setCurrentEmployeeIndex(0, true);
                        document.getElementById('record-button').disabled = false;
                        document.getElementById('skip-button').disabled = false;
                    } else {
                        document.getElementById('current-employee-display').textContent = 'è¯·å…ˆæ·»åŠ å‘˜å·¥';
                    }
                    
                    addEventListeners();
                }, 100);
            }, 100);
        }
        
        // æ›´æ–°æ—¥æœŸä¿¡æ¯
        function updateDateInfo(date) {
            currentDate = date;
            todayStr = currentDate.toLocaleDateString('zh-CN');
            todayFullDate = currentDate.toISOString().split('T')[0];
            
            // æ›´æ–°æ˜¾ç¤ºçš„æ—¥æœŸ
            const options = { month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = currentDate.toLocaleDateString('zh-CN', options);
        }
        
        // åŠ è½½æ•°æ®
        function loadData() {
            try {
                const storedEmployees = localStorage.getItem('employees');
                const storedRecords = localStorage.getItem('salaryRecords');
                
                if (storedEmployees) {
                    employees = JSON.parse(storedEmployees);
                }
                
                if (storedRecords) {
                    salaryRecords = JSON.parse(storedRecords);
                }
            } catch (e) {
                console.error('æ•°æ®åŠ è½½é”™è¯¯:', e);
                employees = [];
                salaryRecords = [];
            }
        }
        
        // ä¿å­˜æ•°æ®
        function saveData() {
            try {
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('salaryRecords', JSON.stringify(salaryRecords));
            } catch (e) {
                console.error('æ•°æ®ä¿å­˜é”™è¯¯:', e);
                showToast('æ•°æ®ä¿å­˜å¤±è´¥');
            }
        }
        
        // æ›´æ–°å‘˜å·¥åˆ—è¡¨
        function updateEmployeesList() {
            const employeesList = document.getElementById('employees-list');
            
            if (employees.length === 0) {
                employeesList.innerHTML = '<p class="text-gray-500 text-center p-3">æš‚æ— å‘˜å·¥</p>';
                return;
            }
            
            let html = '';
            employees.forEach((name, index) => {
                html += `
                <div class="employee-item">
                    <span>${name}</span>
                    <button class="delete-btn" data-index="${index}">Ã—</button>
                </div>
                `;
            });
            
            employeesList.innerHTML = html;
        }
        
        // æ›´æ–°ä»Šæ—¥çŠ¶æ€åˆ—è¡¨
        function updateTodayStatusList() {
            const todayStatusList = document.getElementById('today-status-list');
            
            if (employees.length === 0) {
                todayStatusList.innerHTML = '<p class="text-gray-500 text-center p-3">æš‚æ— å‘˜å·¥ä¿¡æ¯</p>';
                return;
            }
            
            let html = '';
            employees.forEach(name => {
                const isRegistered = isEmployeeRegistered(name);
                const salary = getEmployeeTodaySalary(name);
                
                html += `
                <div class="status-item ${isRegistered ? 'registered' : ''}">
                    <div class="flex items-center">
                        <span class="employee-indicator ${isRegistered ? 'bg-success' : 'bg-gray-300'}"></span>
                        <span>${name}</span>
                    </div>
                    <span>${isRegistered ? salary.toFixed(2) + 'å…ƒ' : 'æœªç™»è®°'}</span>
                </div>
                `;
            });
            
            todayStatusList.innerHTML = html;
        }
        
        // è®¾ç½®å½“å‰å‘˜å·¥ç´¢å¼•
        function setCurrentEmployeeIndex(index, autoSkip) {
            if (employees.length === 0) return;
            
            // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
            currentEmployeeIndex = ((index % employees.length) + employees.length) % employees.length;
            const currentEmployee = employees[currentEmployeeIndex];
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('current-employee-display').textContent = currentEmployee;
            document.getElementById('employee-progress').textContent = `å‘˜å·¥ ${currentEmployeeIndex + 1}/${employees.length}`;
            
            // æ£€æŸ¥å½“å‰å‘˜å·¥æ˜¯å¦å·²ç™»è®°
            const isRegistered = isEmployeeRegistered(currentEmployee);
            const salary = getEmployeeTodaySalary(currentEmployee);
            
            // æ›´æ–°è¾“å…¥æ¡†å’ŒæŒ‰é’®çŠ¶æ€
            const salaryInput = document.getElementById('today-salary');
            salaryInput.value = isRegistered ? salary.toFixed(2) : '';
            
            if (isRegistered) {
                document.getElementById('record-button').classList.add('hidden');
                document.getElementById('re-register-button').classList.remove('hidden');
                salaryInput.disabled = true;
            } else {
                document.getElementById('re-register-button').classList.add('hidden');
                document.getElementById('record-button').classList.remove('hidden');
                salaryInput.disabled = false;
                salaryInput.focus();
            }
            
            // å¦‚æœéœ€è¦è‡ªåŠ¨è·³è¿‡å·²ç™»è®°çš„å‘˜å·¥
            if (autoSkip && isRegistered) {
                const nextIndex = findNextUnregisteredEmployee(currentEmployeeIndex + 1);
                if (nextIndex !== -1 && nextIndex !== currentEmployeeIndex) {
                    setTimeout(() => setCurrentEmployeeIndex(nextIndex, true), 0);
                    return;
                }
            }
            
            // æ’­æ”¾æç¤ºè¯­éŸ³ï¼ˆå¦‚æœæœªç™»è®°ï¼‰
            if (!isRegistered) {
                addToVoiceQueue(`è¯·ä¸º${currentEmployee}ç™»è®°ä»Šå¤©çš„å·¥èµ„æ•°é¢`);
            }
        }
        
        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªç™»è®°çš„å‘˜å·¥
        function findNextUnregisteredEmployee(startIndex) {
            if (employees.length === 0) return -1;
            
            for (let i = 0; i < employees.length; i++) {
                const index = (startIndex + i) % employees.length;
                if (!isEmployeeRegistered(employees[index])) {
                    return index;
                }
            }
            return -1; // æ‰€æœ‰å‘˜å·¥éƒ½å·²ç™»è®°
        }
        
        // æ£€æŸ¥å‘˜å·¥æ˜¯å¦å·²ç™»è®°
        function isEmployeeRegistered(name) {
            return salaryRecords.some(r => r.dateStr === todayStr && r.name === name);
        }
        
        // è·å–å‘˜å·¥ä»Šæ—¥å·¥èµ„
        function getEmployeeTodaySalary(name) {
            const record = salaryRecords.find(r => r.dateStr === todayStr && r.name === name);
            return record ? record.salary : null;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å‘˜å·¥éƒ½å·²ç™»è®°
        function checkAllRegistered() {
            if (employees.length === 0) return false;
            
            for (const name of employees) {
                if (!isEmployeeRegistered(name)) {
                    return false;
                }
            }
            
            // æ‰€æœ‰å‘˜å·¥éƒ½å·²ç™»è®°
            setTimeout(() => {
                announceAllRegisteredSummary();
            }, 500);
            return true;
        }
        
        // å®£å¸ƒæ‰€æœ‰å‘˜å·¥å·²ç™»è®°çš„æ±‡æ€»ä¿¡æ¯
        function announceAllRegisteredSummary() {
            let totalSalary = 0;
            const employeeSalaries = [];
            
            employees.forEach(name => {
                const salary = getEmployeeTodaySalary(name);
                if (salary !== null) {
                    totalSalary += salary;
                    employeeSalaries.push(`${name}${salary}å…ƒ`);
                }
            });
            
            const dateText = currentDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
            let summaryText = `ä»Šæ—¥${dateText}æ‰€æœ‰å‘˜å·¥å·¥èµ„å·²ç™»è®°å®Œæˆã€‚`;
            
            if (employeeSalaries.length > 0) {
                summaryText += `å·¥èµ„åˆ†åˆ«æ˜¯ï¼š${employeeSalaries.join('ï¼Œ')}ã€‚`;
                summaryText += `æ€»è®¡é‡‘é¢ï¼š${totalSalary.toFixed(2)}å…ƒã€‚`;
            }
            
            addToVoiceQueue(summaryText);
            showToast('æ‰€æœ‰å‘˜å·¥å·²ç™»è®°å®Œæˆï¼');
        }
        
        // è®°å½•å·¥èµ„
        function recordSalary() {
            const salaryInput = document.getElementById('today-salary');
            const salary = parseFloat(salaryInput.value);
            
            if (isNaN(salary) || salary < 0) {
                addToVoiceQueue('è¯·è¾“å…¥æœ‰æ•ˆçš„å·¥èµ„æ•°é¢');
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å·¥èµ„æ•°é¢');
                salaryInput.focus();
                return;
            }
            
            const currentEmployee = employees[currentEmployeeIndex];
            const formattedSalary = parseFloat(salary.toFixed(2));
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®°å½•ï¼Œæœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ·»åŠ 
            const existingRecordIndex = salaryRecords.findIndex(
                r => r.dateStr === todayStr && r.name === currentEmployee
            );
            
            if (existingRecordIndex >= 0) {
                salaryRecords[existingRecordIndex].salary = formattedSalary;
            } else {
                salaryRecords.push({
                    date: currentDate.toISOString(),
                    dateStr: todayStr,
                    name: currentEmployee,
                    salary: formattedSalary
                });
            }
            
            saveData();
            updateTodayStatusList();
            salaryInput.value = '';
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.getElementById('record-button').classList.add('hidden');
            document.getElementById('re-register-button').classList.remove('hidden');
            salaryInput.disabled = true;
            
            addToVoiceQueue(`${currentEmployee}çš„å·¥èµ„å·²ç™»è®°ä¸º${formattedSalary}å…ƒ`);
            showToast(`${currentEmployee}çš„å·¥èµ„å·²ç™»è®°`);
            
            // è‡ªåŠ¨è·³åˆ°ä¸‹ä¸€ä¸ªæœªç™»è®°çš„å‘˜å·¥
            const nextIndex = findNextUnregisteredEmployee(currentEmployeeIndex + 1);
            if (nextIndex !== -1) {
                setCurrentEmployeeIndex(nextIndex, false);
            } else {
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å‘˜å·¥éƒ½å·²ç™»è®°
                checkAllRegistered();
            }
        }
        
        // è·³è¿‡å½“å‰å‘˜å·¥
        function skipEmployee() {
            const nextIndex = findNextUnregisteredEmployee(currentEmployeeIndex + 1);
            if (nextIndex !== -1) {
                setCurrentEmployeeIndex(nextIndex, false);
            } else {
                // æ‰€æœ‰å‘˜å·¥éƒ½å·²ç™»è®°ï¼Œå›åˆ°ç¬¬ä¸€ä¸ª
                setCurrentEmployeeIndex(0, false);
                checkAllRegistered();
            }
        }
        
        // æ·»åŠ å‘˜å·¥
        function addEmployee(name) {
            if (!name || name.trim() === '') {
                addToVoiceQueue('è¯·è¾“å…¥å‘˜å·¥å§“å');
                showToast('è¯·è¾“å…¥å‘˜å·¥å§“å');
                return false;
            }
            
            name = name.trim();
            if (employees.includes(name)) {
                addToVoiceQueue('è¯¥å‘˜å·¥å·²å­˜åœ¨');
                showToast('è¯¥å‘˜å·¥å·²å­˜åœ¨');
                return false;
            }
            
            employees.push(name);
            saveData();
            updateEmployeesList();
            
            addToVoiceQueue(`å·²æ·»åŠ å‘˜å·¥${name}`);
            showToast(`å·²æ·»åŠ å‘˜å·¥${name}`);
            return true;
        }
        
        // åˆ é™¤å‘˜å·¥
        function deleteEmployee(index) {
            if (index < 0 || index >= employees.length) return;
            
            const name = employees[index];
            employees.splice(index, 1);
            
            // åˆ é™¤è¯¥å‘˜å·¥çš„æ‰€æœ‰å·¥èµ„è®°å½•
            salaryRecords = salaryRecords.filter(record => record.name !== name);
            
            saveData();
            updateEmployeesList();
            updateTodayStatusList();
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å‘˜å·¥ï¼Œé‡æ–°è®¾ç½®å½“å‰å‘˜å·¥ç´¢å¼•
            if (index === currentEmployeeIndex) {
                currentEmployeeIndex = 0;
                setCurrentEmployeeIndex(0, true);
            } else if (index < currentEmployeeIndex) {
                currentEmployeeIndex--;
                setCurrentEmployeeIndex(currentEmployeeIndex, false);
            }
            
            addToVoiceQueue(`å·²åˆ é™¤å‘˜å·¥${name}`);
            showToast(`å·²åˆ é™¤å‘˜å·¥${name}`);
        }
        
        // å¯¼å‡ºåˆ°Excel - ä¼˜åŒ–ç‰ˆæœ¬
        function exportToExcel() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (salaryRecords.length === 0) {
                addToVoiceQueue('æ²¡æœ‰å¯å¯¼å‡ºçš„å·¥èµ„è®°å½•');
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„å·¥èµ„è®°å½•');
                return;
            }
            
            // åŠ¨æ€åŠ è½½xlsxåº“ï¼Œå¢åŠ å¤‡ç”¨é“¾æ¥å’Œé‡è¯•æœºåˆ¶
            if (!xlsxScriptLoaded) {
                showToast('æ­£åœ¨å‡†å¤‡å¯¼å‡ºï¼Œè¯·ç¨å€™...');
                loadXLSXScript(0); // å¼€å§‹åŠ è½½ï¼Œå‚æ•°ä¸ºå°è¯•æ¬¡æ•°
            } else {
                performExport();
            }
        }
        
        // åŠ è½½XLSXè„šæœ¬ï¼Œæ”¯æŒé‡è¯•å’Œå¤‡ç”¨é“¾æ¥
        function loadXLSXScript(attempt) {
            const maxAttempts = 2;
            const cdnLinks = [
                'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js' // å¤‡ç”¨é“¾æ¥
            ];

            if (attempt >= maxAttempts) {
                showToast('å¯¼å‡ºåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                return;
            }

            const script = document.createElement('script');
            script.src = cdnLinks[attempt];
            script.onload = function() {
                xlsxScriptLoaded = true;
                performExport();
            };
            script.onerror = function() {
                // åŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé“¾æ¥
                loadXLSXScript(attempt + 1);
            };
            document.head.appendChild(script);
        }
        
        // æ‰§è¡Œå¯¼å‡º
        function performExport() {
            try {
                // æŒ‰æœˆä»½åˆ†ç»„æ•°æ®
                const monthGroups = {};
                
                salaryRecords.forEach(record => {
                    const date = new Date(record.date);
                    const monthKey = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
                    
                    if (!monthGroups[monthKey]) {
                        monthGroups[monthKey] = {};
                    }
                    
                    if (!monthGroups[monthKey][record.name]) {
                        monthGroups[monthKey][record.name] = [];
                    }
                    
                    monthGroups[monthKey][record.name].push({
                        date: record.dateStr,
                        salary: record.salary
                    });
                });
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // ä¸ºæ¯ä¸ªæœˆåˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨
                Object.keys(monthGroups).forEach(month => {
                    const monthData = monthGroups[month];
                    const employeesInMonth = Object.keys(monthData);
                    
                    // è·å–è¯¥æœˆçš„æ‰€æœ‰æ—¥æœŸï¼ˆå»é‡å¹¶æ’åºï¼‰
                    const datesSet = new Set();
                    employeesInMonth.forEach(name => {
                        monthData[name].forEach(entry => datesSet.add(entry.date));
                    });
                    const dates = Array.from(datesSet).sort((a, b) => new Date(a) - new Date(b));
                    
                    // å‡†å¤‡è¡¨æ ¼æ•°æ®
                    const wsData = [];
                    // è¡¨å¤´ï¼šæ—¥æœŸ + å‘˜å·¥å§“å
                    const header = ['æ—¥æœŸ', ...employeesInMonth, 'å½“æ—¥æ€»è®¡'];
                    wsData.push(header);
                    
                    // å¡«å……æ¯æ—¥æ•°æ®
                    dates.forEach(date => {
                        const row = [date];
                        let dailyTotal = 0;
                        
                        employeesInMonth.forEach(name => {
                            const entry = monthData[name].find(e => e.date === date);
                            const salary = entry ? entry.salary : '';
                            row.push(salary);
                            if (salary !== '') dailyTotal += salary;
                        });
                        
                        row.push(dailyTotal.toFixed(2));
                        wsData.push(row);
                    });
                    
                    // æ·»åŠ æ€»è®¡è¡Œ
                    const totalRow = ['æ€»è®¡'];
                    let grandTotal = 0;
                    
                    employeesInMonth.forEach(name => {
                        const total = monthData[name].reduce((sum, entry) => sum + entry.salary, 0);
                        totalRow.push(total.toFixed(2));
                        grandTotal += total;
                    });
                    
                    totalRow.push(grandTotal.toFixed(2));
                    wsData.push(totalRow);
                    
                    // åˆ›å»ºå·¥ä½œè¡¨å¹¶æ·»åŠ åˆ°å·¥ä½œç°¿
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, month);
                });
                
                // ç”Ÿæˆæ–‡ä»¶å
                const now = new Date();
                const fileName = `å·¥èµ„è®°å½•_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.xlsx`;
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, fileName);
                
                addToVoiceQueue('å·¥èµ„è®°å½•å¯¼å‡ºæˆåŠŸ');
                showToast('å¯¼å‡ºæˆåŠŸï¼');
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                addToVoiceQueue('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function addEventListeners() {
            // ç™»è®°æŒ‰é’®
            document.getElementById('record-button').addEventListener('click', recordSalary);
            
            // é‡æ–°ç™»è®°æŒ‰é’®
            document.getElementById('re-register-button').addEventListener('click', function() {
                document.getElementById('re-register-button').classList.add('hidden');
                document.getElementById('record-button').classList.remove('hidden');
                const salaryInput = document.getElementById('today-salary');
                salaryInput.disabled = false;
                salaryInput.focus();
            });
            
            // è·³è¿‡æŒ‰é’®
            document.getElementById('skip-button').addEventListener('click', skipEmployee);
            
            // è®¾ç½®æŒ‰é’®
            document.getElementById('settings-button').addEventListener('click', function() {
                document.getElementById('main-screen').classList.add('hidden');
                document.getElementById('settings-screen').classList.remove('hidden');
            });
            
            // è¿”å›æŒ‰é’®
            document.getElementById('back-button').addEventListener('click', function() {
                document.getElementById('settings-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('hidden');
                updateTodayStatusList();
            });
            
            // ä¿å­˜æ—¥æœŸè®¾ç½®
            document.getElementById('save-date-button').addEventListener('click', function() {
                const dateInput = document.getElementById('setting-date');
                const newDate = new Date(dateInput.value);
                
                if (isNaN(newDate.getTime())) {
                    addToVoiceQueue('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¥æœŸ');
                    showToast('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¥æœŸ');
                    return;
                }
                
                updateDateInfo(newDate);
                updateTodayStatusList();
                setCurrentEmployeeIndex(0, true);
                
                addToVoiceQueue('æ—¥æœŸè®¾ç½®å·²ä¿å­˜');
                showToast('æ—¥æœŸè®¾ç½®å·²ä¿å­˜');
            });
            
            // æ·»åŠ å‘˜å·¥
            document.getElementById('add-employee-button').addEventListener('click', function() {
                const nameInput = document.getElementById('new-employee-name');
                const name = nameInput.value.trim();
                
                if (addEmployee(name)) {
                    nameInput.value = '';
                    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå‘˜å·¥ï¼Œè®¾ç½®ä¸ºå½“å‰å‘˜å·¥
                    if (employees.length === 1) {
                        setCurrentEmployeeIndex(0, true);
                        document.getElementById('record-button').disabled = false;
                        document.getElementById('skip-button').disabled = false;
                    }
                }
                
                nameInput.focus();
            });
            
            // å‘˜å·¥å§“åè¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.getElementById('new-employee-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('add-employee-button').click();
                }
            });
            
            // å·¥èµ„è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.getElementById('today-salary').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (!document.getElementById('record-button').classList.contains('hidden')) {
                        document.getElementById('record-button').click();
                    }
                }
            });
            
            // å¯¼å‡ºæŒ‰é’®
            document.getElementById('export-button').addEventListener('click', exportToExcel);
            
            // å‘˜å·¥åˆ—è¡¨åˆ é™¤æŒ‰é’®äº‹ä»¶å§”æ‰˜
            document.getElementById('employees-list').addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    if (confirm(`ç¡®å®šè¦åˆ é™¤å‘˜å·¥"${employees[index]}"å—ï¼Ÿ`)) {
                        deleteEmployee(index);
                    }
                }
            });
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // è§¦å‘é‡æ’åæ·»åŠ æ˜¾ç¤ºç±»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3ç§’åéšè—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // æ£€æŸ¥éŸ³é¢‘æ”¯æŒ
        function checkAudioSupport() {
            audioSupported = !!window.speechSynthesis;
        }
        
        // æ·»åŠ åˆ°è¯­éŸ³é˜Ÿåˆ—
        function addToVoiceQueue(text) {
            if (!audioSupported) return;
            
            voiceQueue.push(text);
            if (!isProcessingQueue) {
                processVoiceQueue();
            }
        }
        
        // å¤„ç†è¯­éŸ³é˜Ÿåˆ—
        function processVoiceQueue() {
            if (voiceQueue.length === 0) {
                isProcessingQueue = false;
                return;
            }
            
            isProcessingQueue = true;
            const text = voiceQueue.shift();
            
            // åˆå§‹åŒ–è¯­éŸ³åˆæˆ
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            
            // æ’­æ”¾å¼€å§‹
            utterance.onstart = function() {
                isSpeaking = true;
                document.getElementById('voice-indicator').classList.add('active');
            };
            
            // æ’­æ”¾ç»“æŸ
            utterance.onend = function() {
                isSpeaking = false;
                document.getElementById('voice-indicator').classList.remove('active');
                setTimeout(processVoiceQueue, 200);
            };
            
            // æ’­æ”¾é”™è¯¯
            utterance.onerror = function() {
                isSpeaking = false;
                document.getElementById('voice-indicator').classList.remove('active');
                setTimeout(processVoiceQueue, 500);
            };
            
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>